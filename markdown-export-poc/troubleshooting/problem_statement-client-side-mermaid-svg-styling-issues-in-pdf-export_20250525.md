# Client-Side Mermaid SVG Styling Issues in PDF Export

## Problem Statement
Mermaid diagrams rendered client-side display correctly in the HTML preview but lose their visual styling (e.g., node colors, text colors, line styles) when exported to PDF using the `html-to-pdfmake` and `pdfMake` libraries. Despite various attempts to manipulate the SVG DOM or SVG string representation before PDF conversion, the styling in the generated PDF does not consistently match the preview.

## Table of Contents
* [Background](#background)
* [Attempted Fixes](#attempted-fixes)
* [Hypothesis](#hypothesis)
* [Dependencies](#dependencies)
  * [markdown-export-poc/index.html](#markdown-export-pocindexhtml)
  * [markdown-export-poc/main.js](#markdown-export-pocmainjs)
  * [markdown-export-poc/default.md](#markdown-export-pocdefaultmd)

## Background
A proof-of-concept (POC) aims to demonstrate a fully client-side workflow for converting Markdown (including Mermaid diagrams) to an HTML preview, and then exporting this preview to PDF and DOCX. The initial POC setup uses `markdown-it` for Markdown parsing, `mermaid` for diagram rendering, `html-to-pdfmake` to convert HTML to a `pdfMake` document definition, and `pdfMake` for PDF generation. While the HTML preview renders Mermaid diagrams correctly, and basic PDF generation (text, bookmarks) works, the visual fidelity of Mermaid diagrams in the PDF output is poor, typically resulting in black-filled nodes and invisible text.

## Attempted Fixes
1.  **Mermaid Theme Adjustments:**
    *   Tried `mermaid.initialize({ theme: 'base' })` to use a simpler theme.
    *   Tried `mermaid.initialize({ theme: 'dark' })` along with `themeVariables` like `nodeTextColor: '#FFFFFF'`.
2.  **Direct DOM Manipulation of Live SVG:**
    *   Post-rendering, selected SVG elements (`text`, `rect`, `path`) in the live DOM and attempted to set their `fill`, `stroke`, and `stroke-width` attributes/styles. This negatively affected the live preview.
3.  **DOM Manipulation of Cloned SVG:**
    *   Cloned the preview container or the SVG element itself.
    *   Removed internal `<style>` tags from the cloned SVG.
    *   Applied direct `fill`, `stroke`, and `stroke-width` attributes to various elements (nodes, text, edges, arrowheads) within the cloned SVG.
    *   Re-serialized the modified cloned SVG back into its cloned container's `innerHTML` before passing to `htmlToPdfmake`.
4.  **SVG String Manipulation:**
    *   Obtained the `outerHTML` of the rendered SVG.
    *   Used string replacement (regex) to remove internal `<style>` tags.
    *   Used string replacement (regex) to inject/overwrite `fill`, `stroke`, and `stroke-width` attributes for various SVG elements.
    *   Replaced the original Mermaid diagram's `innerHTML` in a copy of the full preview's HTML content with this modified SVG string.

## Hypothesis
The `html-to-pdfmake` library and/or `pdfMake`'s SVG rendering engine have limitations in interpreting or prioritizing CSS styles (whether from internal `<style>` blocks or inline `style` attributes) and direct SVG presentation attributes for complex SVGs like those generated by Mermaid. `pdfMake` might be applying its own default styling to SVG elements or failing to parse/apply specific attributes correctly, leading to the observed visual discrepancies. The issue is likely rooted in the conversion from a styled SVG (either via CSS or attributes) to the `pdfMake` document definition object, or in `pdfMake`'s subsequent rendering of that definition.