# Mermaid Diagram Rendering Issue - Investigation Summary & Pivot to Playwright Rendering

**Date:** 2025-05-21

**Problem:** Mermaid diagrams, specifically flowchart node labels, are not rendering correctly in the final PDF. Text is missing from nodes.

**Previous Approach (Take 10):**
*   Use JSDOM with polyfills for `getBBox` and `getComputedTextLength` to render Mermaid diagrams server-side.
*   Set `htmlLabels: false` in Mermaid configuration for `flowchart`, `sequence`, and `state` diagrams to force SVG text rendering instead of `<foreignObject>`.
*   Use `playwright-dom-correction.js` to fix SVG issues (like `viewBox`) in a headless browser before PDF generation.

**Investigation Findings (from console logs and raw SVG output):**

1.  **`htmlLabels: false` Not Fully Respected for Flowchart Nodes:**
    *   Despite `flowchart: { htmlLabels: false }`, Mermaid (v11.6.0) in the JSDOM environment continues to use `<foreignObject>` elements for flowchart *node* labels (e.g., "Start", "Is it working?").
    *   Logs: `fakeBBox for foreignObject: text: "Start..."`
    *   Raw SVG: Node labels are wrapped in `<foreignObject>`.

2.  **Zero-Dimension `<foreignObject>` for Node Labels:**
    *   The `<foreignObject>` elements for node labels in the JSDOM-generated raw SVG have `width="0" height="0"`.
    *   This is the direct cause of missing node text.
    *   Mermaid does not seem to use the dimensions provided by our `fakeBBox` polyfill to set the `width` and `height` attributes of these `<foreignObject>` elements in its final SVG output.

3.  **SVG `<text>` Used for Edge Labels:**
    *   Edge labels (e.g., "Yes", "No") are correctly rendered using SVG `<text>` and `<tspan>` elements. This part seems to work as expected.

4.  **`playwright-dom-correction.js` (Initial State):**
    *   The JSDOM-generated SVGs had incorrect initial `viewBox` attributes.
    *   `playwright-dom-correction.js` was crucial for correcting these `viewBox` attributes.

**Conclusion on JSDOM Approach:**
The JSDOM-based approach with polyfills was insufficient for reliable flowchart node text rendering due to Mermaid's behavior in JSDOM.

**Implemented Solution: Pivot to Headless Browser Rendering for Mermaid Diagrams**

This plan was successfully implemented. `MarkdownService` now uses Playwright to render Mermaid diagrams.

**Key Implementation Steps Taken:**

1.  **Modified `MarkdownService.parse`:**
    *   Identifies ` ```mermaid ` code blocks.
    *   If Mermaid blocks are present, a single Playwright `Browser` instance is launched for the duration of the `parse()` call.
    *   For each Mermaid diagram:
        *   A helper function (`renderMermaidPage`) is called with the browser instance.
        *   **Minimal HTML Creation:** A self-contained HTML string is constructed with the Mermaid library (from CDN), the diagram code, and an initialization script.
        *   **Playwright Page Rendering:** A new page is created in the browser. `page.setContent()` loads the HTML. `page.waitForFunction()` waits for the SVG to render with valid dimensions.
        *   **SVG Extraction:** `page.evaluate()` extracts the `outerHTML` of the rendered `<svg>`.
        *   The page is closed.
    *   The browser instance is closed after all diagrams in the `parse()` call are processed.
    *   The extracted, browser-rendered SVG is injected into the main HTML.

**Outcome of Implemented Solution:**

*   **Correct Rendering:** Mermaid diagrams, including all text in nodes and edges, now render correctly in the intermediate HTML and the final PDF.
*   **Well-Formed SVGs:** The SVGs generated by Playwright are well-formed.
*   **`playwright-dom-correction.js` Update:** This script (run by `PlaywrightPdfEngine`) was modified to skip `viewBox` correction for SVGs generated by `MarkdownService`'s Playwright process (identified by ID pattern `mermaid-pw-*`), as this correction is no longer needed for them. Other general SVG fixes in the script remain.

**This approach has resolved the primary Mermaid rendering issues.**