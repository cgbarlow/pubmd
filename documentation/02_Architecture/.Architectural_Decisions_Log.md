Do a# Architectural Decisions Log & Action Plan Alignment

This document records the approved architectural decisions based on the "Solution Options Analysis Paper" and subsequent strategic refinements. It also analyzes the alignment of the project's implementation plan with the roadmap outlined in [`README.md`](../../README.md).

## 1. Approved Architectural Decisions

The following architectural decisions, as recommended in [`solution_options_analysis.md`](solution_options_analysis.md) and refined by later research (e.g., [`issue_research_test-pdf-service_JSDOM_ESMbuild_html2canvas.md`](../03_Implementation/issue_research_test-pdf-service_JSDOM_ESMbuild_html2canvas.md)), are hereby approved:

| Decision Area             | Approved Solution                                                                 | Reference (Analysis Paper Section / Other) |
|---------------------------|-----------------------------------------------------------------------------------|--------------------------------------------|
| **1. Componentisation**   | Single `@pubmd/core` library within a pnpm workspace monorepo, written in TypeScript. | Section 1 (solution_options_analysis.md)   |
| **2A. CLI Tech Stack**    | Node.js + TypeScript, using `commander.js`.                                       | Section 2A (solution_options_analysis.md)  |
| **2B. CLI Packaging**     | Publish as an npm package (`npm i -g pubmd-cli`) AND provide pre-built binaries via `pkg`. Optional Dockerfile for CI. | Section 2B (solution_options_analysis.md)  |
| **3. .docx Export**       | HTML-to-DOCX conversion using `docx` library (primary engine for programmatic construction, via `DocxJsEngine`) and `html-to-docx` library (fallback engine for direct HTML conversion, via `HtmlToDocxEngine`). Integrated into `DocxService` within `@pubmd/core` using an engine pattern. | Section 3 (solution_options_analysis.md), evolved by `issue_research_test-pdf-service_JSDOM_ESMbuild_html2canvas.md` & subsequent plans. |
| **4. PDF Generation**   | Primary PDF generation via `Playwright` (headless browser engine) for high fidelity. Fallback to `jsPDF` + `html2canvas` (via `JsPdfEngine`) for environments without browser access. Integrated into `PdfService` within `@pubmd/core` using an engine pattern. | `issue_research_test-pdf-service_JSDOM_ESMbuild_html2canvas.md` |
| **5. Testing Strategy**   | Unit: Vitest (or Jest) + `ts-jest`.<br>Integration (Web/PDF): Playwright headless Chromium PDF snapshot diff.<br>CLI: `zx` / shell scripts in CI.<br>Static Analysis: ESLint, Prettier, TypeScript strict.<br>CI: GitHub Actions matrix. | Section 4 (solution_options_analysis.md) |
| **6. Dependency Mgt.**  | pnpm workspace, `pnpm-lock.yaml`, Renovate Bot, semantic-release. Publish to GitHub Packages. | Section 5 (solution_options_analysis.md) |

## 2. Alignment Analysis: Implementation Plan vs. Roadmap

This section assesses the alignment between the detailed [Project Implementation Plan](../03_Implementation/Implementation_Plan.md) and the high-level "Next Steps / Roadmap" outlined in [`README.md`](../../README.md).

**Roadmap Summary (from [`README.md`](../../README.md)):**
*   **Initial 5-Week Sprint Cycle:** Establish `@pubmd/core`, ensure web UI stability, then develop functional `pubmd-cli`, implement modern dev practices.
*   **Phase 2 (Post Initial Sprint Cycle):** Core PDF Functionality & Bug Fixes (List rendering, PDF navigation).
*   **Phase 3:** Feature Enhancements & Polish (.docx refinement, GitHub link, CLI enhancements).
*   **Phase 4:** Advanced User Experience (Full-screen view for web UI).

**Implementation Plan Summary ([`Implementation_Plan.md`](../03_Implementation/Implementation_Plan.md)):**
The [`Implementation_Plan.md`](../03_Implementation/Implementation_Plan.md) details a 5-week initial sprint cycle focused on:
1.  **Week 1:** Foundational setup (`pnpm` workspace, TypeScript) and migration of core logic to `@pubmd/core`, including `PdfService` refactor (Playwright engine) and web UI integration.
2.  **Week 2:** **Crucial web UI stability verification** with the refactored core (using Playwright), followed by initial CLI scaffolding.
3.  **Week 3:** Focused `pubmd-cli` development and integration with `@pubmd/core`.
4.  **Week 4:** Begin implementation of `DocxService` (using `docx` and `html-to-docx` libraries via engine pattern). Expand testing for `PdfService` (Playwright) and `DocxService`.
5.  **Week 5:** CLI packaging (`pkg`, npm), CI/CD setup, and DevOps automation (Renovate, semantic-release).

It also outlines subsequent phases for PDF bug fixes, .docx finalization, CLI enhancements, and advanced web UI features.

**Conclusion on Alignment:**
The detailed [Project Implementation Plan](../03_Implementation/Implementation_Plan.md) is **strongly aligned** with achieving the goals of the **Initial 5-Week Sprint Cycle** as defined in the [`README.md`](../../README.md) roadmap. It correctly prioritizes and sequences:
1.  The refactoring of core logic into `@pubmd/core`, including the updated PDF generation strategy.
2.  Ensuring the existing web application's stability with this new core as a critical checkpoint.
3.  Proceeding with the development of the `pubmd-cli` and supporting DevOps infrastructure.

The `DocxService` implementation with `docx` and `html-to-docx` starting in Week 4 directly addresses a Phase 3 roadmap item, providing a solid foundation early in the project. The subsequent phases detailed in the implementation plan directly correspond to Phases 2, 3, and 4 of the [`README.md`](../../README.md) roadmap.