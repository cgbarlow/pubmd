# Active Context

**Current Task**: Performing MUP. Reflecting initial implementation of `PdfService` in `@pubmd/core`, including types, service structure, placeholder HTML rendering, exports, and a test script.

**Overall Cycle Goal**: Integrate the `@pubmd/core` package into the existing web UI.

**Last MUP Action**: MUP for `npm install` in `nodejs_projects/core/` and removal of `@types/html2canvas`.

**Recent Actions & State Change**:
- **`PdfService` Initial Implementation (`@pubmd/core`)**:
    - Created `nodejs_projects/core/src/services/pdf/pdf.types.ts` with `IPdfService` and `PdfOptions`.
    - Created `nodejs_projects/core/src/services/pdf/pdf.service.ts` with basic class structure, constructor, and placeholder implementation for `generatePdfFromHtml` (using `pdf.text()`) and `generatePdfFromMarkdown` (which calls the HTML method).
    - Updated `nodejs_projects/core/src/index.ts` to export `PdfService`, `IPdfService`, and `PdfOptions`.
    - Created `nodejs_projects/core/scripts/test-pdf-service.mjs` with JSDOM/DOMPurify setup and tests for both methods, saving output to PDF files.
    - Added `test:pdf` script to `nodejs_projects/core/package.json`.
- **`npm install` in `nodejs_projects/core/`**: Completed successfully.
- **Dependency Cleanup**: Removed deprecated `@types/html2canvas` from `nodejs_projects/core/package.json`.
- **Web UI Testing of `MarkdownService` Integration**:
    - `src/web/index.html` updated with an import map.
    - **Test Result**: Markdown preview (including Mermaid SVGs) in the web UI works flawlessly using the core `MarkdownService`.
    - **New Issue Identified**: Mermaid SVGs (rendered by `MarkdownService`) do *not* appear in the PDF generated by the *current local PDF generation logic* in `script.js`.

**Current State**:
- Execution phase ongoing.
- MUP in progress for initial `PdfService` implementation.
- `@pubmd/core` `MarkdownService` is functional.
- `@pubmd/core` `PdfService` has a basic structure and can generate placeholder PDFs. Full HTML rendering (via `html2canvas`) is pending.
- **Known Issue**: SVGs (specifically Mermaid diagrams) generated by `MarkdownService` are not rendering in PDFs created by the existing `html2canvas`-based logic in `script.js`. This is the primary issue the full `PdfService` implementation aims to address.
- PDF generation and Font handling in the web UI still use local logic.

**Next Steps (MUP in progress)**:
- Update further CRCT files (`.clinerules`, `changelog.md`, `progress.md`).
- After MUP:
    1. Build `@pubmd/core`.
    2. Run `npm run test:pdf` to verify the placeholder `PdfService` functionality.
    3. Proceed with implementing the full `html2canvas` logic within `PdfService.generatePdfFromHtml`, focusing on UI-agnosticism and SVG rendering.