# Active Context

**Current Task**: Performing MUP due to context window usage (27%) and to align with `.clinerules` `next_action`.

**Overall Cycle Goal**: Integrate the `@pubmd/core` package into the existing web UI, and lay the groundwork for CLI and new services (PDF, DOCX).

**Last MUP Action**: Completion of architectural document updates and `PdfGenerationOptions` refactor.

**Recent Actions & State Change**:
- **Architectural Document Updates**:
    - Updated `documentation/02_Architecture/Solution_Architecture_Design_Specification.md` to reflect Playwright-first `PdfService` and `docx`/`html-to-docx` engine-based `DocxService`. Version 1.1, Date 2025-05-20.
    - Updated `documentation/02_Architecture/.Architectural_Decisions_Log.md` to include decisions for the new PDF and DOCX strategies and align implementation plan summary.
    - Updated `documentation/03_Implementation/Implementation_Plan.md` (Week 4 & Phase 3) to reflect `docx`/`html-to-docx` strategy for `DocxService` instead of `mammoth.js`.
- **`PdfService` Type Refactor (`@pubmd/core`)**:
    - Updated `nodejs_projects/core/src/services/pdf/pdf.service.ts` to use `PdfGenerationOptions` instead of `PdfOptions`.
    - Updated `nodejs_projects/core/src/index.ts` to export `PdfGenerationOptions`.
- **Previous State (still relevant)**:
    - `PdfService` initial placeholder implementation was created.
    - `npm install` in `nodejs_projects/core/` completed.
    - Dependency Cleanup: Removed deprecated `@types/html2canvas`.
    - Web UI Testing of `MarkdownService` Integration: Successful.
    - New Issue Identified: Mermaid SVGs (rendered by `MarkdownService`) do *not* appear in the PDF generated by the *current local PDF generation logic* in `script.js`.

**Current State**:
- Execution phase ongoing.
- MUP in progress for architectural alignment, `PdfGenerationOptions` refactor, and context window management.
- `@pubmd/core` `MarkdownService` is functional.
- `@pubmd/core` `PdfService` now uses `PdfGenerationOptions`. The legacy engine within it (using `html2canvas`) is still present. The primary `PlaywrightEngine` is planned for implementation.
- **Known Issue**: SVGs (specifically Mermaid diagrams) generated by `MarkdownService` are not rendering in PDFs created by the existing `html2canvas`-based logic in `script.js`. This is a key issue the `PlaywrightEngine` for `PdfService` aims to address.
- PDF generation and Font handling in the web UI still use local logic from `script.js`.

**Next Steps (MUP in progress)**:
- Update CRCT files: `changelog.md`, `.clinerules`, `progress.md`.

**Next Steps (After MUP)**:
- Based on `.clinerules` `next_action` and `documentation/03_Implementation/Implementation_Plan.md`:
    1.  Build `@pubmd/core`.
    2.  Run `npm run test:pdf` in `nodejs_projects/core` to verify the `PdfService` (legacy engine) with `PdfGenerationOptions`.
    3.  Implement full `html2canvas` logic in `PdfService` (if `test:pdf` reveals issues or if it's a distinct step before Playwright).
    4.  Proceed with Week 1/Week 2 tasks:
        - Ensure Web UI stability with the refactored `@pubmd/core` (including `PdfService` consuming HTML from `MarkdownService`).
        - Implement initial unit tests for `@pubmd/core`.
        - Begin scaffolding `pubmd-cli`.
    5.  Address `DocxService` implementation (Week 4 task) or `PlaywrightEngine` for `PdfService`.